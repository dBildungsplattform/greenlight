#!/usr/bin/env bash

source bin/config.env

echo "Greenlight-v3 starting on port: $PORT"

echo "Postgres host: $PGHOST"
echo "Postgres port: $PGPORT"

echo "Redis host: $RDHOST"
echo "Redis port: $RDPORT"

if [ "$RAILS_ENV" = "production" ]; then
  while ! nc -zw3 $PGHOST $PGPORT; do
    echo "Waiting for postgres to start up ..."
    sleep 1
  done

  while ! nc -zw3 $RDHOST $RDPORT; do
    echo "Waiting for redis to start up ..."
    sleep 1
  done
fi

cd ./bin # TODO: How it worked without changing directory?

rails assets:precompile
rails db:create
rails db:migrate:with_data

# Write environment variables to crontab
env | grep -v 'no_proxy' | while read -r line; do
  echo "$line"
done >/etc/crontabs/root

echo "* * * * * /usr/src/app/cronjobs/daily_rake_tasks.sh >> /var/log/cron.log 2>&1" >>/etc/crontabs/root # TODO: Change to daily for production "0 0 * * *"

# Start cron daemon as a background process
crond

exec rails s -b 0.0.0.0 -p $PORT
